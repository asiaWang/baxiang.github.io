---
layout: post
title: Block(闭包)
tags:  object-c
Keywords: block
category: object-c
---
对象与对象之间的通信方式一般分为三种：

- 代理-协议 (通信方式是1对1)

- 通知（通信方式是1对多）

- block （通信方式是1对1）

1.什么是Block?

Block是一个匿名的函数代码块，此代码块可以作为参数传递给我iqita对象。Block也可以拥有返回值。但是它与函数有所不同的是block是定义在函数或者方法内部，并且可以访问在函数或者方法范围内的，block范围之外的任何变量。

2.块的定义与使用

block以  ^ 标示符开头，后面跟一个括号表示所需要的参数列表。


{% highlight objective-c linenos %}
//Block的声明

int(^ myBlock)(int);
//Block的创建

myBlock= ^(int a){
	int result=a+a;
	return result;
}

// Block的调用

int ret = myBlocks(10);

{% endhighlight %}

第一种定义一个Block的步骤比较麻烦，我们可以将block定义成一个类型如下：

{% highlight objective-c linenos %}
//定义block类型
	typedef int (^MyBlock)(int);
//Block声明
MyBlock myBlock=^(int a){
	int result = a +a;
	return result;
}

{% endhighlight %}


例2
{% highlight objective-c linenos %}

 #import <Foundation/Foundation.h>
 int main(int argc,char * ragv[])
 {
 	@autoreleasepool{
 		void(^print_message)(void) =^(void){
 			NSLog(@"Programming is fun.");
 		};
 		print_message();
 	}
 	
 	return 0;
 }



{% endhighlight %}

3.接下来的例子是使用块替代函数重新编写的。块；能够定义为全局或者局部的。

{% highlight objective-c linenos %}
	#import <Foundation/Foundation.h>
	//计算第N个三角数的会
	void( ^calculateTraiangularNumber)(int) =^(int n){
		int i,triangularNumber = 0;
		for(i = 1;i<=n,++i){
		 triangularNumber +=i;
		 NSLog(@"Triangular number %i is %i",n,triangularNumber);		}	
	};
	int main(int argc,char *argvp[])
	{
		@autoreasepool{
			calculateTriangularNumber (10);
			calculateTriangularNumber(20);
			calculateTriangularNumber(50);
		}
		return 0;
	}

{% endhighlight %}

4.两个对象之间使用Block进行传值

 (1)rootViewController.h
 {% highlight objective-c linenos%}
#import <UIKit/UIKit.h>

@interface rootViewController : UIViewController

@end

 {%endhighlight%}
（2）接收值控制器，rootViewController.m
{% highlight objective-c linenos %}

#import "rootViewController.h"
#import "SecondViewController.h"


@interface rootViewController ()
{
    UILabel *label;
}


@end

@implementation rootViewController

- (id)initWithNibName:(NSString *)nibNameOrNil bundle:(NSBundle *)nibBundleOrNil
{
    self = [super initWithNibName:nibNameOrNil bundle:nibBundleOrNil];
    if (self) {
        // Custom initialization
    }
    return self;
}

- (void)viewDidLoad
{
    [super viewDidLoad];

    label=[[UILabel alloc]initWithFrame:CGRectMake(80, 100, 80, 80)];
    label.text=@"获取的值";
    label.layer.borderWidth=1;
    label.backgroundColor=[UIColor orangeColor];
    [self.view addSubview:label];
    
    UIButton *button=[UIButton buttonWithType:UIButtonTypeRoundedRect];
    button.frame=CGRectMake(80, 200, 80, 80);
    [button setTitle:@"获取值" forState:UIControlStateNormal];
    [button addTarget:self action:@selector(pushToAnother) forControlEvents:UIControlEventTouchUpInside];
    [button setBackgroundColor:[UIColor orangeColor]];
    [self.view addSubview:button];
    
}

-(void)pushToAnother
{
    SecondViewController *second=[[SecondViewController alloc]init];
    second.block=^(NSString *showText){
        label.text=showText;
    };
    [self presentViewController:second animated:YES completion:^{
        NSLog(@"传送成功");
    }];
}


@end

{% endhighlight %}

(3)传值控制器:SecondViewController.h;SecondViewController.m

{% highlight objective-c linenos %}
//.h文件
#import <UIKit/UIKit.h>
typedef void (^valueBlock)(NSString *returnVlue);
@interface SecondViewController : UIViewController
@property(nonatomic,copy)valueBlock block;

-(void)returnMyBlock:(valueBlock)block;

@end

{% endhighlight %}

{% highlight objective-c linenos %}
//.m文件
#import "SecondViewController.h"
#import "rootViewController.h"
@interface SecondViewController ()

@property(nonatomic,retain)UITextField *Field;

@end

@implementation SecondViewController

- (id)initWithNibName:(NSString *)nibNameOrNil bundle:(NSBundle *)nibBundleOrNil
{
    self = [super initWithNibName:nibNameOrNil bundle:nibBundleOrNil];
    if (self) {
        // Custom initialization
    }
    return self;
}


- (void)viewDidLoad
{
    [super viewDidLoad];
    
    
    _Field=[[UITextField alloc]initWithFrame:CGRectMake(100, 100, 100, 100)];
    _Field.text=@"获得的值是";
    _Field.backgroundColor=[UIColor lightGrayColor];
    [self.view addSubview:_Field];
    
    UIButton *button=[UIButton buttonWithType:UIButtonTypeRoundedRect];
    button.frame=CGRectMake(100, 220, 50, 50);
    [button setTitle:@"传送" forState:UIControlStateNormal];
    [button addTarget:self action:@selector(back) forControlEvents:UIControlEventTouchUpInside];
    [self.view addSubview:button];
    
}

-(void)returnMyBlock:(valueBlock)returnblock
{
    self.block = returnblock;
}

-(void)viewWillDisappear:(BOOL)animated
{
    self.block(self.Field.text);
}

-(void)back
{
    [self dismissViewControllerAnimated:YES completion:^{
        NSLog(@"返回成功");
    }];
}
@end


{% endhighlight %}